<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1440 Sensorial Global</title>
<meta name="description" content="Envie pulsos an√¥nimos pelo mundo e veja mensagens em tempo real em um mapa interativo.">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
html, body { 
  height:100%; 
  margin:0; 
  padding:0; 
  font-family:Georgia, serif; 
  background:#0f1115; 
  color:#fff; 
  overflow:hidden;
}
body { 
  display:flex; 
  flex-direction:column; 
}
#map { 
  flex:1; 
  width:100%; 
}
.panel { 
  height:30vh; 
  min-height:120px; 
  padding:10px; 
  background:rgba(15,17,21,0.95); 
  display:flex; 
  flex-direction:column;
  border-top:1px solid rgba(255,255,255,0.1);
}
.time { 
  text-align:center; 
  font-size:2rem; 
  margin-bottom:5px;
  font-weight:300;
  letter-spacing:2px;
}
textarea { 
  width:100%; 
  background:rgba(0,0,0,0.3); 
  border:1px solid #555; 
  color:#eaeaea; 
  padding:12px; 
  resize:none; 
  font-family:Georgia, serif;
  font-size:1rem;
  border-radius:4px;
  transition:all 0.3s;
  min-height:60px;
}
textarea:focus { 
  outline:none; 
  border-color:#4d79ff; 
  box-shadow:0 0 0 2px rgba(77,121,255,0.2);
}
button { 
  margin-top:10px; 
  padding:10px 20px; 
  background:linear-gradient(135deg, #4d79ff 0%, #9933ff 100%);
  border:none;
  color:#fff; 
  cursor:pointer; 
  font-family:Georgia, serif;
  font-size:1rem;
  border-radius:4px;
  transition:all 0.3s;
  font-weight:bold;
}
button:hover { 
  transform:translateY(-2px);
  box-shadow:0 5px 15px rgba(77,121,255,0.4);
}
button:disabled {
  background:linear-gradient(135deg, #666 0%, #888 100%);
  cursor:not-allowed;
  transform:none;
  box-shadow:none;
}
.cards { 
  margin-top:10px; 
  display:flex; 
  flex-direction:column; 
  gap:5px; 
  max-height:100%; 
  overflow-y:auto;
  flex:1;
}
.card { 
  background:rgba(255,255,255,0.05); 
  border:1px solid rgba(255,255,255,0.1); 
  padding:10px; 
  font-size:0.85rem; 
  cursor:pointer; 
  transition:0.2s;
  border-radius:4px;
  animation:fadeIn 0.3s ease-out;
}
.card:hover { 
  background:rgba(255,255,255,0.15);
  transform:translateX(5px);
}
.leaflet-popup-content { 
  color:#000; 
  font-size:0.9rem; 
  font-family:Georgia, serif; 
  max-width:250px;
}
.leaflet-popup-content strong {
  color:#4d79ff;
}

/* Anima√ß√µes */
@keyframes fadeIn {
  from { opacity:0; transform:translateY(10px); }
  to { opacity:1; transform:translateY(0); }
}
@keyframes pulse {
  0% { transform:scale(1); }
  50% { transform:scale(1.05); }
  100% { transform:scale(1); }
}
@keyframes float {
  0%, 100% { transform:translateY(0); }
  50% { transform:translateY(-5px); }
}

/* Scrollbar personalizada */
.cards::-webkit-scrollbar {
  width:6px;
}
.cards::-webkit-scrollbar-track {
  background:rgba(255,255,255,0.1);
  border-radius:3px;
}
.cards::-webkit-scrollbar-thumb {
  background:linear-gradient(135deg, #4d79ff 0%, #9933ff 100%);
  border-radius:3px;
}

/* Bot√µes de controle */
.control-btn {
  position:absolute;
  z-index:1000;
  background:rgba(15,17,21,0.8);
  color:white;
  border:1px solid rgba(255,255,255,0.2);
  padding:8px 12px;
  border-radius:4px;
  cursor:pointer;
  font-family:Georgia, serif;
  font-size:0.9rem;
  transition:all 0.3s;
}
.control-btn:hover {
  background:rgba(15,17,21,0.95);
  border-color:#4d79ff;
}
#soundToggle { top:10px; right:10px; }
#languageToggle { top:10px; right:70px; }
#themeToggle { top:10px; right:130px; }

/* Aviso de seguran√ßa */
.security-warning {
  position:absolute;
  bottom:10px;
  left:10px;
  z-index:1000;
  background:rgba(255,50,50,0.2);
  border:1px solid rgba(255,100,100,0.5);
  color:#ff9999;
  padding:5px 10px;
  border-radius:4px;
  font-size:0.7rem;
  max-width:200px;
  backdrop-filter:blur(5px);
}

/* Responsividade */
@media (max-height: 600px) {
  .panel { height:40vh; }
  .time { font-size:1.5rem; }
  textarea { min-height:50px; padding:8px; }
}
@media (max-width: 768px) {
  .control-btn { padding:6px 10px; font-size:0.8rem; }
  #languageToggle { right:60px; }
  #themeToggle { right:110px; }
}

/* Tema claro (opcional) */
body.light-theme {
  background:#f0f2f5;
  color:#333;
}
body.light-theme .panel {
  background:rgba(240,242,245,0.95);
  border-top:1px solid rgba(0,0,0,0.1);
}
body.light-theme textarea {
  background:rgba(255,255,255,0.9);
  border:1px solid #ccc;
  color:#333;
}
body.light-theme .card {
  background:rgba(255,255,255,0.7);
  border:1px solid rgba(0,0,0,0.1);
  color:#333;
}
body.light-theme .control-btn {
  background:rgba(255,255,255,0.9);
  color:#333;
  border:1px solid rgba(0,0,0,0.1);
}
</style>
</head>
<body>

<div id="map"></div>

<div class="panel">
  <div class="time" id="time">--:--</div>
  <textarea id="input" maxlength="200"></textarea>
  <button id="registerBtn"></button>
  <div class="cards" id="cards"></div>
</div>

<!-- √Åudios -->
<audio id="pingAudio" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" preload="auto"></audio>
<audio id="ambientAudio" loop preload="auto">
  <source src="https://assets.mixkit.co/music/preview/mixkit-deep-urban-623.mp3" type="audio/mpeg">
</audio>

<!-- Bot√µes de controle -->
<button id="soundToggle" class="control-btn">üîá</button>
<button id="languageToggle" class="control-btn">üåê</button>
<button id="themeToggle" class="control-btn">üåô</button>

<!-- Aviso de seguran√ßa (para testes) -->
<div class="security-warning">
  ‚ö†Ô∏è MODO TESTE: Chaves expostas. Para produ√ß√£o, use backend.
</div>

<!-- LEAFLET -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- SUPABASE (APENAS PARA TESTES) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/upabase.min.js"></script>

<script>
// ======================== AVISO IMPORTANTE ========================
console.warn("‚ö†Ô∏è ATEN√á√ÉO: Esta vers√£o exp√µe chaves do Supabase no frontend.");
console.warn("Para produ√ß√£o, NUNCA fa√ßa isso. Crie um backend com API pr√≥pria.");

// ======================== CONFIGURA√á√ïES ========================
const CONFIG = {
  MAX_MARKERS: 50,
  MAX_CARDS: 7,
  MAX_MESSAGE_LENGTH: 200,
  PARTICLE_DISTANCE: 100000, // metros
  CLEANUP_INTERVAL: 60000, // 1 minuto
  PULSE_INTERVAL: 50, // ms
  DEBOUNCE_TIME: 100 // ms
};

// ======================== TRADU√á√ïES ========================
const translations = {
  pt: { 
    placeholder: "Deixe um pulso no mundo...",
    register: "Registrar Pulso",
    sending: "Enviando...",
    sent: "‚úì Enviado!",
    error: "‚úó Erro!",
    expires: "Expira em 24h",
    placeholder1: "O que est√° sentindo agora?",
    placeholder2: "Compartilhe um pensamento...",
    placeholder3: "Deixe sua marca no mundo...",
    placeholder4: "Um pulso de esperan√ßa...",
    placeholder5: "O que o mundo precisa ouvir?",
    soundOn: "üîä",
    soundOff: "üîá",
    themeLight: "‚òÄÔ∏è",
    themeDark: "üåô"
  },
  en: { 
    placeholder: "Leave a pulse in the world...",
    register: "Register Pulse",
    sending: "Sending...",
    sent: "‚úì Sent!",
    error: "‚úó Error!",
    expires: "Expires in 24h",
    placeholder1: "What are you feeling now?",
    placeholder2: "Share a thought...",
    placeholder3: "Leave your mark on the world...",
    placeholder4: "A pulse of hope...",
    placeholder5: "What does the world need to hear?",
    soundOn: "üîä",
    soundOff: "üîá",
    themeLight: "‚òÄÔ∏è",
    themeDark: "üåô"
  },
  es: { 
    placeholder: "Deja un pulso en el mundo...",
    register: "Registrar Pulso",
    sending: "Enviando...",
    sent: "‚úì ¬°Enviado!",
    error: "‚úó ¬°Error!",
    expires: "Expira en 24h",
    placeholder1: "¬øQu√© est√°s sintiendo ahora?",
    placeholder2: "Comparte un pensamiento...",
    placeholder3: "Deja tu marca en el mundo...",
    placeholder4: "Un pulso de esperanza...",
    placeholder5: "¬øQu√© necesita escuchar el mundo?",
    soundOn: "üîä",
    soundOff: "üîá",
    themeLight: "‚òÄÔ∏è",
    themeDark: "üåô"
  }
};

// ======================== ESTADO GLOBAL ========================
const STATE = {
  lang: navigator.language.startsWith("en") ? "en" :
        navigator.language.startsWith("es") ? "es" : "pt",
  isSoundOn: false,
  isDarkTheme: true,
  markers: [],
  particleLines: [],
  currentMessages: [],
  existingIds: new Set(),
  isFirstLoad: true,
  typingPlaceholderIndex: 0,
  typingCharIndex: 0,
  isDeleting: false,
  particleTimeout: null,
  cleanupInterval: null
};

// ======================== INICIALIZA√á√ÉO ========================
document.addEventListener('DOMContentLoaded', () => {
  // Configurar tema inicial
  document.body.classList.toggle('light-theme', !STATE.isDarkTheme);
  
  // Configurar idioma
  setLanguage();
  
  // Inicializar mapa
  initMap();
  
  // Inicializar rel√≥gio
  updateTime();
  setInterval(updateTime, 1000);
  
  // Inicializar efeito de digita√ß√£o no placeholder
  startTypingEffect();
  
  // Inicializar Supabase (APENAS PARA TESTES)
  initSupabase();
  
  // Carregar mensagens iniciais
  fetchMessages();
  
  // Configurar limpeza peri√≥dica
  STATE.cleanupInterval = setInterval(cleanupOldMarkers, CONFIG.CLEANUP_INTERVAL);
  
  // Configurar event listeners
  setupEventListeners();
});

// ======================== FUN√á√ïES DE IDIOMA ========================
function setLanguage() {
  const t = translations[STATE.lang];
  document.getElementById("input").placeholder = t.placeholder;
  document.getElementById("registerBtn").textContent = t.register;
  document.getElementById("themeToggle").textContent = STATE.isDarkTheme ? t.themeLight : t.themeDark;
  document.getElementById("soundToggle").textContent = STATE.isSoundOn ? t.soundOn : t.soundOff;
}

function toggleLanguage() {
  const langs = ['pt', 'en', 'es'];
  const currentIndex = langs.indexOf(STATE.lang);
  STATE.lang = langs[(currentIndex + 1) % langs.length];
  setLanguage();
  renderCards(STATE.currentMessages);
}

// ======================== EFEITO DE DIGITA√á√ÉO ========================
function startTypingEffect() {
  typePlaceholder();
}

function typePlaceholder() {
  const input = document.getElementById("input");
  const t = translations[STATE.lang];
  const placeholders = [
    t.placeholder1,
    t.placeholder2,
    t.placeholder3,
    t.placeholder4,
    t.placeholder5
  ];
  
  const text = placeholders[STATE.typingPlaceholderIndex];
  
  if (!STATE.isDeleting && STATE.typingCharIndex <= text.length) {
    input.placeholder = text.substring(0, STATE.typingCharIndex) + " ‚ñà";
    STATE.typingCharIndex++;
    setTimeout(typePlaceholder, 50);
  } else if (STATE.isDeleting && STATE.typingCharIndex >= 0) {
    input.placeholder = text.substring(0, STATE.typingCharIndex) + " ‚ñà";
    STATE.typingCharIndex--;
    setTimeout(typePlaceholder, 30);
  } else {
    STATE.isDeleting = !STATE.isDeleting;
    if (!STATE.isDeleting) {
      STATE.typingPlaceholderIndex = (STATE.typingPlaceholderIndex + 1) % placeholders.length;
    }
    setTimeout(typePlaceholder, 1000);
  }
}

// ======================== MAPA ========================
function initMap() {
  window.map = L.map('map').setView([20, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    maxZoom: 19
  }).addTo(window.map);
}

// ======================== REL√ìGIO ========================
function updateTime() { 
  const d = new Date(); 
  document.getElementById("time").textContent = 
    String(d.getHours()).padStart(2, '0') + ":" + 
    String(d.getMinutes()).padStart(2, '0');
}

// ======================== SUPABASE (APENAS PARA TESTES) ========================
function initSupabase() {
  // ‚ö†Ô∏è ATEN√á√ÉO: Em produ√ß√£o, NUNCA exponha chaves no frontend!
  const SUPABASE_URL = 'https://eheyuoeagrfvqxgpmaex.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_1qg0L7fR4drbzru3sQmqtQ_eCTCZECn';
  
  window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  // Configurar realtime
  supabaseClient.channel('public:messages')
    .on('postgres_changes', { 
      event: 'INSERT', 
      schema: 'public', 
      table: 'messages' 
    }, payload => {
      const m = payload.new;
      if (STATE.existingIds.has(m.id)) return;
      STATE.existingIds.add(m.id);
      
      if (Date.now() - new Date(m.inserted_at).getTime() <= 24 * 60 * 60 * 1000) {
        const marker = createPulse(m.latitude, m.longitude, m.text, m.inserted_at);
        m.marker = marker;
        STATE.markers.push(marker);
        STATE.currentMessages.unshift(m);
        renderCards(STATE.currentMessages);
        debounceDrawParticles();
        
        // Tocar som de notifica√ß√£o
        if (STATE.isSoundOn) {
          document.getElementById('pingAudio').currentTime = 0;
          document.getElementById('pingAudio').play();
        }
      }
    })
    .subscribe();
}

// ======================== COR DOS PULSOS ========================
function getPulseColor() {
  const h = new Date().getHours();
  if (h < 5) return "#4d79ff";    // Noite
  if (h < 12) return "#ffd966";   // Manh√£
  if (h < 18) return "#ff9900";   // Tarde
  return "#9933ff";               // Noite
}

// ======================== CRIAR PULSO ========================
function createPulse(lat, lng, text, date) {
  const color = getPulseColor();
  const marker = L.circleMarker([lat, lng], {
    radius: 10,
    fillColor: color,
    fillOpacity: 0.8,
    stroke: true,
    color: "#fff",
    weight: 2,
    text: text,
    inserted_at: date
  }).addTo(window.map);
  
  const t = translations[STATE.lang];
  marker.bindPopup(`
    <div style="max-width:250px;">
      <strong style="color:${color}">"${text}"</strong><br>
      <small>${new Date(date).toLocaleString()}</small><br>
      <small><em>${t.expires}</em></small>
    </div>
  `);
  
  // Anima√ß√£o de pulso
  let r = 10;
  const pulseInterval = setInterval(() => {
    r += 0.5;
    marker.setRadius(r);
    marker.setStyle({ fillOpacity: Math.max(0, 0.8 - (r - 10) / 20) });
    if (r >= 30) r = 10;
  }, CONFIG.PULSE_INTERVAL);
  
  // Armazenar intervalo para limpeza posterior
  marker.pulseInterval = pulseInterval;
  
  return marker;
}

// ======================== RENDERIZAR CARDS ========================
function renderCards(messages) {
  const cardsEl = document.getElementById("cards");
  const t = translations[STATE.lang];
  
  cardsEl.innerHTML = "";
  messages.slice(0, CONFIG.MAX_CARDS).forEach(m => {
    const div = document.createElement("div");
    div.className = "card";
    const date = new Date(m.inserted_at);
    
    // Formatar texto (truncar se muito longo)
    let text = m.text;
    if (text.length > 60) {
      text = text.substring(0, 57) + "...";
    }
    
    div.innerHTML = `
      <div style="display:flex; justify-content:space-between;">
        <strong style="color:#4d79ff">${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}</strong>
        <small>${date.toLocaleDateString()}</small>
      </div>
      <div style="margin-top:5px;">"${text}"</div>
    `;
    
    div.onclick = () => {
      if (m.marker) {
        m.marker.openPopup();
        window.map.setView(m.marker.getLatLng(), 8);
      }
    };
    
    cardsEl.appendChild(div);
  });
}

// ======================== PART√çCULAS ========================
function clearParticles() {
  STATE.particleLines.forEach(line => window.map.removeLayer(line));
  STATE.particleLines = [];
}

function drawParticles() {
  clearParticles();
  
  for (let i = 0; i < STATE.markers.length; i++) {
    for (let j = i + 1; j < STATE.markers.length; j++) {
      const m1 = STATE.markers[i].getLatLng();
      const m2 = STATE.markers[j].getLatLng();
      
      if (window.map.distance(m1, m2) < CONFIG.PARTICLE_DISTANCE) {
        const color = STATE.isDarkTheme ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.2)';
        const line = L.polyline([m1, m2], {
          color: color,
          weight: 1,
          dashArray: '5, 5'
        }).addTo(window.map);
        STATE.particleLines.push(line);
      }
    }
  }
}

function debounceDrawParticles() {
  clearTimeout(STATE.particleTimeout);
  STATE.particleTimeout = setTimeout(drawParticles, CONFIG.DEBOUNCE_TIME);
}

// ======================== ENVIAR MENSAGEM ========================
async function sendMessage() {
  const btn = document.getElementById("registerBtn");
  const input = document.getElementById("input");
  const t = translations[STATE.lang];
  
  // Verificar geolocaliza√ß√£o
  if (!navigator.geolocation) {
    alert("GPS n√£o dispon√≠vel no seu navegador.");
    return;
  }
  
  // Verificar texto
  const text = input.value.trim();
  if (!text) {
    input.focus();
    return;
  }
  
  if (text.length > CONFIG.MAX_MESSAGE_LENGTH) {
    alert(`Mensagem muito longa (m√°x. ${CONFIG.MAX_MESSAGE_LENGTH} caracteres)`);
    return;
  }
  
  // Desabilitar bot√£o e mostrar estado de envio
  const originalText = btn.textContent;
  btn.textContent = t.sending;
  btn.disabled = true;
  
  try {
    // Obter localiza√ß√£o
    const position = await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    });
    
    // Adicionar pequena varia√ß√£o aleat√≥ria
    const lat = position.coords.latitude + (Math.random() - 0.5) * 0.02;
    const lng = position.coords.longitude + (Math.random() - 0.5) * 0.02;
    
    // Enviar para Supabase (APENAS PARA TESTES)
    const { data, error } = await supabaseClient
      .from('messages')
      .insert([{ text, latitude: lat, longitude: lng }]);
    
    if (error) throw error;
    
    // Sucesso
    btn.textContent = t.sent;
    input.value = "";
    
    // Tocar som
    document.getElementById('pingAudio').currentTime = 0;
    document.getElementById('pingAudio').play();
    
    // Restaurar bot√£o ap√≥s 2 segundos
    setTimeout(() => {
      btn.textContent = originalText;
      btn.disabled = false;
    }, 2000);
    
  } catch (error) {
    console.error("Erro ao enviar mensagem:", error);
    btn.textContent = t.error;
    
    // Restaurar bot√£o ap√≥s 2 segundos
    setTimeout(() => {
      btn.textContent = originalText;
      btn.disabled = false;
    }, 2000);
    
    alert("Erro ao enviar mensagem. Verifique sua conex√£o e permiss√£o de localiza√ß√£o.");
  }
}

// ======================== BUSCAR MENSAGENS ========================
async function fetchMessages() {
  try {
    const { data, error } = await supabaseClient
      .from('messages')
      .select('*')
      .order('inserted_at', { ascending: false })
      .limit(100);
    
    if (error) throw error;
    
    const now = Date.now();
    STATE.currentMessages = [];
    STATE.markers.forEach(marker => {
      if (marker.pulseInterval) clearInterval(marker.pulseInterval);
      window.map.removeLayer(marker);
    });
    STATE.markers = [];
    
    data.forEach(m => {
      if (now - new Date(m.inserted_at).getTime() <= 24 * 60 * 60 * 1000) {
        STATE.existingIds.add(m.id);
        const marker = createPulse(m.latitude, m.longitude, m.text, m.inserted_at);
        m.marker = marker;
        STATE.currentMessages.push(m);
        STATE.markers.push(marker);
      }
    });
    
    // Zoom para mostrar todos os marcadores
    if (STATE.isFirstLoad && STATE.markers.length > 0) {
      const group = L.featureGroup(STATE.markers);
      window.map.fitBounds(group.getBounds().pad(0.1));
      STATE.isFirstLoad = false;
    }
    
    debounceDrawParticles();
    renderCards(STATE.currentMessages);
    
  } catch (error) {
    console.error("Erro ao buscar mensagens:", error);
  }
}

// ======================== LIMPEZA ========================
function cleanupOldMarkers() {
  const now = Date.now();
  const markersToRemove = [];
  
  STATE.markers = STATE.markers.filter(marker => {
    const popupText = marker.getPopup()?.getContent();
    if (!popupText) return true;
    
    // Extrair data da mensagem
    const match = popupText.match(/(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z)/);
    if (!match) return true;
    
    const inserted = new Date(match[1]).getTime();
    if (now - inserted > 24 * 60 * 60 * 1000) {
      markersToRemove.push(marker);
      return false;
    }
    return true;
  });
  
  // Remover marcadores antigos
  markersToRemove.forEach(marker => {
    if (marker.pulseInterval) clearInterval(marker.pulseInterval);
    window.map.removeLayer(marker);
  });
  
  // Atualizar cards
  STATE.currentMessages = STATE.currentMessages.filter(m => {
    return markersToRemove.indexOf(m.marker) === -1;
  });
  
  renderCards(STATE.currentMessages);
  debounceDrawParticles();
}

// ======================== EVENT LISTENERS ========================
function setupEventListeners() {
  // Bot√£o de registro
  document.getElementById("registerBtn").addEventListener("click", sendMessage);
  
  // Enviar com Enter (Shift+Enter para nova linha)
  document.getElementById("input").addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  
  // Bot√£o de som
  document.getElementById("soundToggle").addEventListener("click", () => {
    const audio = document.getElementById("ambientAudio");
    const pingAudio = document.getElementById("pingAudio");
    STATE.isSoundOn = !STATE.isSoundOn;
    
    document.getElementById("soundToggle").textContent = 
      translations[STATE.lang][STATE.isSoundOn ? "soundOn" : "soundOff"];
    
    if (STATE.isSoundOn) {
      audio.volume = 0.1;
      audio.play().catch(e => console.log("Autoplay bloqueado:", e));
      pingAudio.volume = 0.3;
    } else {
      audio.pause();
    }
  });
  
  // Bot√£o de idioma
  document.getElementById("languageToggle").addEventListener("click", toggleLanguage);
  
  // Bot√£o de tema
  document.getElementById("themeToggle").addEventListener("click", () => {
    STATE.isDarkTheme = !STATE.isDarkTheme;
    document.body.classList.toggle('light-theme', !STATE.isDarkTheme);
    document.getElementById("themeToggle").textContent = 
      translations[STATE.lang][STATE.isDarkTheme ? "themeLight" : "themeDark"];
    debounceDrawParticles();
  });
  
  // Permitir arrastar cards no mobile
  let startY;
  const cardsEl = document.getElementById("cards");
  
  cardsEl.addEventListener('touchstart', (e) => {
    startY = e.touches[0].clientY;
  }, { passive: true });
  
  cardsEl.addEventListener('touchmove', (e) => {
    if (!startY) return;
    const y = e.touches[0].clientY;
    const diff = startY - y;
    
    if (Math.abs(diff) > 10) {
      cardsEl.scrollTop += diff;
      startY = y;
    }
  }, { passive: true });
}

// ======================== EXPORTAR FUN√á√ïES PARA DEBUG ========================
// (Opcional - para console do navegador)
window.debug = {
  getState: () => STATE,
  getMarkers: () => STATE.markers,
  getMessages: () => STATE.currentMessages,
  clearParticles,
  drawParticles,
  fetchMessages,
  forceCleanup: cleanupOldMarkers
};
</script>
</body>
</html>