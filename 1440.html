<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1440 Sensorial Global</title>
<meta name="description" content="Envie pulsos an√¥nimos pelo mundo e veja mensagens em tempo real em um mapa interativo.">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
html, body { 
  height:100%; 
  margin:0; 
  padding:0; 
  font-family:Georgia, serif; 
  background:#0f1115; 
  color:#fff; 
  overflow:hidden;
}
body { 
  display:flex; 
  flex-direction:column; 
}
#map { 
  flex:1; 
  width:100%; 
  z-index:1;
}
.panel { 
  height:35vh; 
  min-height:150px; 
  padding:15px; 
  background:rgba(15,17,21,0.97); 
  display:flex; 
  flex-direction:column;
  border-top:1px solid rgba(255,255,255,0.1);
  z-index:2;
  position:relative;
}
.time { 
  text-align:center; 
  font-size:2rem; 
  margin-bottom:5px;
  font-weight:300;
  letter-spacing:2px;
}
.stats-bar {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
  padding:8px 12px;
  background:rgba(255,255,255,0.05);
  border-radius:6px;
  font-size:0.85rem;
}
.stat-item {
  display:flex;
  align-items:center;
  gap:5px;
}
.stat-icon {
  font-size:1.2rem;
}
.stat-value {
  font-weight:bold;
  color:#4d79ff;
}
.input-container {
  display:flex;
  gap:10px;
  margin-bottom:10px;
}
textarea { 
  flex:1;
  background:rgba(0,0,0,0.3); 
  border:1px solid #555; 
  color:#eaeaea; 
  padding:12px; 
  resize:none; 
  font-family:Georgia, serif;
  font-size:1rem;
  border-radius:4px;
  transition:all 0.3s;
  min-height:60px;
}
textarea:focus { 
  outline:none; 
  border-color:#4d79ff; 
  box-shadow:0 0 0 2px rgba(77,121,255,0.2);
}
button { 
  padding:12px 24px; 
  background:linear-gradient(135deg, #4d79ff 0%, #9933ff 100%);
  border:none;
  color:#fff; 
  cursor:pointer; 
  font-family:Georgia, serif;
  font-size:1rem;
  border-radius:4px;
  transition:all 0.3s;
  font-weight:bold;
  white-space:nowrap;
}
button:hover { 
  transform:translateY(-2px);
  box-shadow:0 5px 15px rgba(77,121,255,0.4);
}
button:disabled {
  background:linear-gradient(135deg, #666 0%, #888 100%);
  cursor:not-allowed;
  transform:none;
  box-shadow:none;
}
.cards-container {
  display:flex;
  gap:10px;
  height:100%;
}
#feed {
  flex:2;
  display:flex;
  flex-direction:column;
}
#cards { 
  flex:1;
  display:flex; 
  flex-direction:column; 
  gap:5px; 
  overflow-y:auto;
  padding-right:5px;
}
.realtime-feed {
  flex:1;
  background:rgba(255,255,255,0.02);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:6px;
  padding:10px;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
.feed-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding-bottom:8px;
  border-bottom:1px solid rgba(255,255,255,0.1);
  margin-bottom:8px;
}
.feed-title {
  font-size:0.9rem;
  color:#4d79ff;
  font-weight:bold;
}
.feed-badge {
  background:#4d79ff;
  color:white;
  padding:2px 8px;
  border-radius:10px;
  font-size:0.7rem;
}
#realtimeMessages {
  flex:1;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:5px;
}
.realtime-message {
  background:rgba(255,255,255,0.03);
  border-left:3px solid #4d79ff;
  padding:8px;
  border-radius:3px;
  font-size:0.8rem;
  animation:fadeIn 0.3s ease-out;
}
.realtime-message.new {
  background:rgba(77,121,255,0.1);
  animation:pulse 1s ease;
}
.realtime-time {
  font-size:0.7rem;
  color:#aaa;
  margin-bottom:3px;
}
.realtime-text {
  overflow:hidden;
  text-overflow:ellipsis;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
}
.card { 
  background:rgba(255,255,255,0.05); 
  border:1px solid rgba(255,255,255,0.1); 
  padding:10px; 
  font-size:0.85rem; 
  cursor:pointer; 
  transition:0.2s;
  border-radius:4px;
  animation:fadeIn 0.3s ease-out;
}
.card:hover { 
  background:rgba(255,255,255,0.15);
  transform:translateX(5px);
}
.leaflet-popup-content { 
  color:#000; 
  font-size:0.9rem; 
  font-family:Georgia, serif; 
  max-width:250px;
  padding:15px;
}
.leaflet-popup-content strong {
  color:#4d79ff;
}
.popup-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
  padding-bottom:8px;
  border-bottom:1px solid #eee;
}
.popup-time {
  font-size:0.8rem;
  color:#666;
}
.popup-expiry {
  font-size:0.7rem;
  color:#ff6b6b;
  margin-top:8px;
  padding-top:8px;
  border-top:1px solid #eee;
}
.popup-location {
  font-size:0.8rem;
  color:#666;
  margin-top:5px;
}
.leaflet-popup-content-wrapper {
  border-radius:8px;
  box-shadow:0 5px 15px rgba(0,0,0,0.3);
}

/* Anima√ß√µes */
@keyframes fadeIn {
  from { opacity:0; transform:translateY(10px); }
  to { opacity:1; transform:translateY(0); }
}
@keyframes pulse {
  0% { transform:scale(1); }
  50% { transform:scale(1.02); }
  100% { transform:scale(1); }
}
@keyframes float {
  0%, 100% { transform:translateY(0); }
  50% { transform:translateY(-5px); }
}

/* Scrollbar personalizada */
#cards::-webkit-scrollbar,
#realtimeMessages::-webkit-scrollbar {
  width:6px;
}
#cards::-webkit-scrollbar-track,
#realtimeMessages::-webkit-scrollbar-track {
  background:rgba(255,255,255,0.1);
  border-radius:3px;
}
#cards::-webkit-scrollbar-thumb,
#realtimeMessages::-webkit-scrollbar-thumb {
  background:linear-gradient(135deg, #4d79ff 0%, #9933ff 100%);
  border-radius:3px;
}

/* Bot√µes de controle */
.control-btn {
  position:absolute;
  z-index:1000;
  background:rgba(15,17,21,0.8);
  color:white;
  border:1px solid rgba(255,255,255,0.2);
  padding:8px 12px;
  border-radius:4px;
  cursor:pointer;
  font-family:Georgia, serif;
  font-size:0.9rem;
  transition:all 0.3s;
}
.control-btn:hover {
  background:rgba(15,17,21,0.95);
  border-color:#4d79ff;
}
#soundToggle { top:10px; right:10px; }
#languageToggle { top:10px; right:70px; }
#themeToggle { top:10px; right:130px; }

/* Indicador de usu√°rios online */
.online-users {
  position:absolute;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  z-index:1000;
  background:rgba(15,17,21,0.9);
  border:1px solid rgba(77,121,255,0.5);
  color:#4d79ff;
  padding:6px 15px;
  border-radius:20px;
  font-size:0.8rem;
  display:flex;
  align-items:center;
  gap:6px;
  backdrop-filter:blur(5px);
}
.online-dot {
  width:8px;
  height:8px;
  background:#4dff4d;
  border-radius:50%;
  animation:pulse 2s infinite;
}

/* Aviso de seguran√ßa */
.security-warning {
  position:absolute;
  bottom:50px;
  left:10px;
  z-index:1000;
  background:rgba(255,50,50,0.2);
  border:1px solid rgba(255,100,100,0.5);
  color:#ff9999;
  padding:5px 10px;
  border-radius:4px;
  font-size:0.7rem;
  max-width:200px;
  backdrop-filter:blur(5px);
}

/* Responsividade */
@media (max-height: 600px) {
  .panel { height:45vh; }
  .time { font-size:1.5rem; }
  textarea { min-height:50px; padding:8px; }
  .cards-container { flex-direction:column; }
}
@media (max-width: 768px) {
  .control-btn { padding:6px 10px; font-size:0.8rem; }
  #languageToggle { right:60px; }
  #themeToggle { right:110px; }
  .cards-container { flex-direction:column; }
  .input-container { flex-direction:column; }
  button { width:100%; }
}

/* Tema claro */
body.light-theme {
  background:#f0f2f5;
  color:#333;
}
body.light-theme .panel {
  background:rgba(240,242,245,0.97);
  border-top:1px solid rgba(0,0,0,0.1);
}
body.light-theme textarea {
  background:rgba(255,255,255,0.9);
  border:1px solid #ccc;
  color:#333;
}
body.light-theme .card,
body.light-theme .realtime-message {
  background:rgba(255,255,255,0.7);
  border:1px solid rgba(0,0,0,0.1);
  color:#333;
}
body.light-theme .control-btn {
  background:rgba(255,255,255,0.9);
  color:#333;
  border:1px solid rgba(0,0,0,0.1);
}
body.light-theme .online-users {
  background:rgba(255,255,255,0.9);
  color:#4d79ff;
}
body.light-theme .stats-bar {
  background:rgba(0,0,0,0.05);
}
</style>
</head>
<body>

<div id="map"></div>

<div class="panel">
  <div class="time" id="time">--:--</div>
  
  <div class="stats-bar">
    <div class="stat-item">
      <span class="stat-icon">üåç</span>
      <span>Pulsos: <span class="stat-value" id="activePulses">0</span></span>
    </div>
    <div class="stat-item">
      <span class="stat-icon">‚è≥</span>
      <span>Expira em: <span class="stat-value" id="nextExpiry">24h</span></span>
    </div>
    <div class="stat-item">
      <span class="stat-icon">üìà</span>
      <span>Hoje: <span class="stat-value" id="todayPulses">0</span></span>
    </div>
  </div>
  
  <div class="input-container">
    <textarea id="input" maxlength="200"></textarea>
    <button id="registerBtn"></button>
  </div>
  
  <div class="cards-container">
    <div id="feed">
      <div class="cards" id="cards"></div>
    </div>
    
    <div class="realtime-feed">
      <div class="feed-header">
        <div class="feed-title">üîÑ Feed em Tempo Real</div>
        <div class="feed-badge" id="realtimeCount">0</div>
      </div>
      <div id="realtimeMessages"></div>
    </div>
  </div>
</div>

<!-- √Åudios -->
<audio id="pingAudio" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" preload="auto"></audio>
<audio id="notificationAudio" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" preload="auto"></audio>
<audio id="ambientAudio" loop preload="auto">
  <source src="https://assets.mixkit.co/music/preview/mixkit-deep-urban-623.mp3" type="audio/mpeg">
</audio>

<!-- Bot√µes de controle -->
<button id="soundToggle" class="control-btn">üîá</button>
<button id="languageToggle" class="control-btn">üåê</button>
<button id="themeToggle" class="control-btn">üåô</button>

<!-- Indicador de usu√°rios online -->
<div class="online-users">
  <div class="online-dot"></div>
  <span id="onlineCount">0</span> pessoas conectadas agora
</div>

<!-- Aviso de seguran√ßa -->
<div class="security-warning">
  ‚ö†Ô∏è MODO TESTE: Para produ√ß√£o, use backend com API pr√≥pria.
</div>

<!-- LEAFLET -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- SUPABASE (APENAS PARA TESTES) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/upabase.min.js"></script>

<script>
// ======================== AVISO IMPORTANTE ========================
console.warn("‚ö†Ô∏è ATEN√á√ÉO: Esta vers√£o exp√µe chaves do Supabase no frontend.");
console.warn("Para produ√ß√£o, NUNCA fa√ßa isso. Crie um backend com API pr√≥pria.");

// ======================== CONFIGURA√á√ïES ========================
const CONFIG = {
  MAX_MARKERS: 50,
  MAX_CARDS: 7,
  MAX_REALTIME_MESSAGES: 15,
  MAX_MESSAGE_LENGTH: 200,
  PARTICLE_DISTANCE: 100000,
  CLEANUP_INTERVAL: 60000,
  PULSE_INTERVAL: 50,
  DEBOUNCE_TIME: 100,
  EXPIRY_HOURS: 24,
  ONLINE_TIMEOUT: 30000 // 30 segundos para considerar offline
};

// ======================== TRADU√á√ïES ========================
const translations = {
  pt: { 
    placeholder: "Deixe um pulso no mundo...",
    register: "Enviar Pulso",
    sending: "Enviando...",
    sent: "‚úì Enviado!",
    error: "‚úó Erro!",
    expires: "Expira em",
    placeholder1: "O que est√° sentindo agora?",
    placeholder2: "Compartilhe um pensamento...",
    placeholder3: "Deixe sua marca no mundo...",
    placeholder4: "Um pulso de esperan√ßa...",
    placeholder5: "O que o mundo precisa ouvir?",
    soundOn: "üîä",
    soundOff: "üîá",
    themeLight: "‚òÄÔ∏è",
    themeDark: "üåô",
    online: "pessoas conectadas agora",
    pulses: "Pulsos",
    today: "Hoje",
    realtimeFeed: "Feed em Tempo Real",
    expiresIn: "Expira em",
    hours: "h",
    minutes: "min",
    justNow: "agora mesmo",
    secondsAgo: "seg atr√°s"
  },
  en: { 
    placeholder: "Leave a pulse in the world...",
    register: "Send Pulse",
    sending: "Sending...",
    sent: "‚úì Sent!",
    error: "‚úó Error!",
    expires: "Expires in",
    placeholder1: "What are you feeling now?",
    placeholder2: "Share a thought...",
    placeholder3: "Leave your mark on the world...",
    placeholder4: "A pulse of hope...",
    placeholder5: "What does the world need to hear?",
    soundOn: "üîä",
    soundOff: "üîá",
    themeLight: "‚òÄÔ∏è",
    themeDark: "üåô",
    online: "people online now",
    pulses: "Pulses",
    today: "Today",
    realtimeFeed: "Realtime Feed",
    expiresIn: "Expires in",
    hours: "h",
    minutes: "min",
    justNow: "just now",
    secondsAgo: "sec ago"
  },
  es: { 
    placeholder: "Deja un pulso en el mundo...",
    register: "Enviar Pulso",
    sending: "Enviando...",
    sent: "‚úì ¬°Enviado!",
    error: "‚úó ¬°Error!",
    expires: "Expira en",
    placeholder1: "¬øQu√© est√°s sintiendo ahora?",
    placeholder2: "Comparte un pensamiento...",
    placeholder3: "Deja tu marca en el mundo...",
    placeholder4: "Un pulso de esperanza...",
    placeholder5: "¬øQu√© necesita escuchar el mundo?",
    soundOn: "üîä",
    soundOff: "üîá",
    themeLight: "‚òÄÔ∏è",
    themeDark: "üåô",
    online: "personas conectadas ahora",
    pulses: "Pulsos",
    today: "Hoy",
    realtimeFeed: "Feed en Tiempo Real",
    expiresIn: "Expira en",
    hours: "h",
    minutes: "min",
    justNow: "ahora mismo",
    secondsAgo: "seg atr√°s"
  }
};

// ======================== ESTADO GLOBAL ========================
const STATE = {
  lang: navigator.language.startsWith("en") ? "en" :
        navigator.language.startsWith("es") ? "es" : "pt",
  isSoundOn: false,
  isDarkTheme: true,
  markers: [],
  particleLines: [],
  currentMessages: [],
  realtimeMessages: [],
  existingIds: new Set(),
  isFirstLoad: true,
  typingPlaceholderIndex: 0,
  typingCharIndex: 0,
  isDeleting: false,
  particleTimeout: null,
  cleanupInterval: null,
  onlineUsers: new Set(),
  userActivity: {},
  todayStart: new Date().setHours(0,0,0,0)
};

// ======================== INICIALIZA√á√ÉO ========================
document.addEventListener('DOMContentLoaded', () => {
  // Configurar tema inicial
  document.body.classList.toggle('light-theme', !STATE.isDarkTheme);
  
  // Configurar idioma
  setLanguage();
  
  // Inicializar mapa
  initMap();
  
  // Inicializar rel√≥gio
  updateTime();
  setInterval(updateTime, 1000);
  
  // Inicializar efeito de digita√ß√£o no placeholder
  startTypingEffect();
  
  // Inicializar Supabase (APENAS PARA TESTES)
  initSupabase();
  
  // Carregar mensagens iniciais
  fetchMessages();
  
  // Configurar limpeza peri√≥dica
  STATE.cleanupInterval = setInterval(cleanupOldMarkers, CONFIG.CLEANUP_INTERVAL);
  
  // Configurar atualiza√ß√£o de estat√≠sticas
  setInterval(updateStats, 5000);
  
  // Configurar atualiza√ß√£o de usu√°rios online
  setInterval(updateOnlineUsers, 10000);
  
  // Configurar event listeners
  setupEventListeners();
  
  // Adicionar usu√°rio atual √† lista de online
  const userId = 'user_' + Math.random().toString(36).substr(2, 9);
  STATE.onlineUsers.add(userId);
  STATE.userActivity[userId] = Date.now();
  updateOnlineUsers();
});

// ======================== FUN√á√ïES DE IDIOMA ========================
function setLanguage() {
  const t = translations[STATE.lang];
  document.getElementById("input").placeholder = t.placeholder;
  document.getElementById("registerBtn").textContent = t.register;
  document.getElementById("themeToggle").textContent = STATE.isDarkTheme ? t.themeLight : t.themeDark;
  document.getElementById("soundToggle").textContent = STATE.isSoundOn ? t.soundOn : t.soundOff;
  document.querySelector(".online-users").lastChild.textContent = " " + t.online;
}

function toggleLanguage() {
  const langs = ['pt', 'en', 'es'];
  const currentIndex = langs.indexOf(STATE.lang);
  STATE.lang = langs[(currentIndex + 1) % langs.length];
  setLanguage();
  renderCards(STATE.currentMessages);
  updateRealtimeFeed();
}

// ======================== EFEITO DE DIGITA√á√ÉO ========================
function startTypingEffect() {
  typePlaceholder();
}

function typePlaceholder() {
  const input = document.getElementById("input");
  const t = translations[STATE.lang];
  const placeholders = [
    t.placeholder1,
    t.placeholder2,
    t.placeholder3,
    t.placeholder4,
    t.placeholder5
  ];
  
  const text = placeholders[STATE.typingPlaceholderIndex];
  
  if (!STATE.isDeleting && STATE.typingCharIndex <= text.length) {
    input.placeholder = text.substring(0, STATE.typingCharIndex) + " ‚ñà";
    STATE.typingCharIndex++;
    setTimeout(typePlaceholder, 50);
  } else if (STATE.isDeleting && STATE.typingCharIndex >= 0) {
    input.placeholder = text.substring(0, STATE.typingCharIndex) + " ‚ñà";
    STATE.typingCharIndex--;
    setTimeout(typePlaceholder, 30);
  } else {
    STATE.isDeleting = !STATE.isDeleting;
    if (!STATE.isDeleting) {
      STATE.typingPlaceholderIndex = (STATE.typingPlaceholderIndex + 1) % placeholders.length;
    }
    setTimeout(typePlaceholder, 1000);
  }
}

// ======================== MAPA ========================
function initMap() {
  window.map = L.map('map').setView([20, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    maxZoom: 19
  }).addTo(window.map);
}

// ======================== REL√ìGIO ========================
function updateTime() { 
  const d = new Date(); 
  document.getElementById("time").textContent = 
    String(d.getHours()).padStart(2, '0') + ":" + 
    String(d.getMinutes()).padStart(2, '0');
}

// ======================== SUPABASE (APENAS PARA TESTES) ========================
function initSupabase() {
  // ‚ö†Ô∏è ATEN√á√ÉO: Em produ√ß√£o, NUNCA exponha chaves no frontend!
  const SUPABASE_URL = 'https://eheyuoeagrfvqxgpmaex.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_1qg0L7fR4drbzru3sQmqtQ_eCTCZECn';
  
  window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  // Configurar realtime para mensagens
  supabaseClient.channel('public:messages')
    .on('postgres_changes', { 
      event: 'INSERT', 
      schema: 'public', 
      table: 'messages' 
    }, payload => {
      handleNewMessage(payload.new);
    })
    .subscribe();
}

// ======================== MANIPULAR NOVA MENSAGEM ========================
function handleNewMessage(m) {
  if (STATE.existingIds.has(m.id)) return;
  STATE.existingIds.add(m.id);
  
  const now = Date.now();
  const messageTime = new Date(m.inserted_at).getTime();
  const expiresIn = CONFIG.EXPIRY_HOURS * 60 * 60 * 1000;
  
  if (now - messageTime <= expiresIn) {
    // Adicionar ao feed em tempo real
    addToRealtimeFeed(m);
    
    // Adicionar marcador no mapa
    const marker = createPulse(m.latitude, m.longitude, m.text, m.inserted_at);
    m.marker = marker;
    STATE.markers.push(marker);
    
    // Adicionar √† lista de mensagens atuais
    STATE.currentMessages.unshift(m);
    
    // Atualizar cards
    renderCards(STATE.currentMessages);
    
    // Atualizar part√≠culas
    debounceDrawParticles();
    
    // Atualizar estat√≠sticas
    updateStats();
    
    // Tocar som de notifica√ß√£o
    if (STATE.isSoundOn) {
      document.getElementById('notificationAudio').currentTime = 0;
      document.getElementById('notificationAudio').play();
    }
    
    // Atualizar usu√°rios online (simula√ß√£o)
    const userId = 'user_' + Math.random().toString(36).substr(2, 9);
    STATE.onlineUsers.add(userId);
    STATE.userActivity[userId] = Date.now();
    updateOnlineUsers();
  }
}

// ======================== COR DOS PULSOS ========================
function getPulseColor() {
  const h = new Date().getHours();
  if (h < 5) return "#4d79ff";    // Noite
  if (h < 12) return "#ffd966";   // Manh√£
  if (h < 18) return "#ff9900";   // Tarde
  return "#9933ff";               // Noite
}

// ======================== CRIAR PULSO (DOT) NO MAPA ========================
function createPulse(lat, lng, text, date) {
  const color = getPulseColor();
  const marker = L.circleMarker([lat, lng], {
    radius: 12,
    fillColor: color,
    fillOpacity: 0.9,
    stroke: true,
    color: "#fff",
    weight: 2,
    text: text,
    inserted_at: date
  }).addTo(window.map);
  
  const t = translations[STATE.lang];
  const expiryTime = new Date(new Date(date).getTime() + (CONFIG.EXPIRY_HOURS * 60 * 60 * 1000));
  const timeDiff = expiryTime - Date.now();
  const hoursLeft = Math.floor(timeDiff / (1000 * 60 * 60));
  const minutesLeft = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
  
  // Criar popup/bala√µ informativo
  const popupContent = `
    <div class="popup-header">
      <strong style="color:${color}">üìå Pulso Sensorial</strong>
      <span class="popup-time">${new Date(date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
    </div>
    <div style="margin:10px 0; padding:10px; background:rgba(0,0,0,0.05); border-radius:5px;">
      <em>"${text}"</em>
    </div>
    <div class="popup-location">
      üìç ${lat.toFixed(4)}, ${lng.toFixed(4)}
    </div>
    <div class="popup-expiry">
      ‚è≥ ${t.expiresIn} ${hoursLeft}${t.hours} ${minutesLeft}${t.minutes}
    </div>
  `;
  
  marker.bindPopup(popupContent);
  
  // Anima√ß√£o de pulso
  let r = 12;
  const pulseInterval = setInterval(() => {
    r += 0.5;
    marker.setRadius(r);
    marker.setStyle({ fillOpacity: Math.max(0, 0.9 - (r - 12) / 25) });
    if (r >= 30) r = 12;
  }, CONFIG.PULSE_INTERVAL);
  
  marker.pulseInterval = pulseInterval;
  
  // Evento de clique para abrir popup
  marker.on('click', function() {
    this.openPopup();
    // Centralizar no marcador
    window.map.setView(this.getLatLng(), Math.max(8, window.map.getZoom()));
  });
  
  return marker;
}

// ======================== RENDERIZAR CARDS ========================
function renderCards(messages) {
  const cardsEl = document.getElementById("cards");
  const t = translations[STATE.lang];
  
  cardsEl.innerHTML = "";
  messages.slice(0, CONFIG.MAX_CARDS).forEach(m => {
    const div = document.createElement("div");
    div.className = "card";
    const date = new Date(m.inserted_at);
    
    // Formatar texto (truncar se muito longo)
    let text = m.text;
    if (text.length > 50) {
      text = text.substring(0, 47) + "...";
    }
    
    // Calcular tempo restante
    const expiryTime = new Date(date.getTime() + (CONFIG.EXPIRY_HOURS * 60 * 60 * 1000));
    const timeDiff = expiryTime - Date.now();
    const hoursLeft = Math.floor(timeDiff / (1000 * 60 * 60));
    const minutesLeft = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
    
    div.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:start;">
        <div>
          <strong style="color:#4d79ff">${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}</strong>
          <div style="font-size:0.8rem; margin-top:3px;">"${text}"</div>
        </div>
        <div style="font-size:0.7rem; color:#aaa; text-align:right;">
          ${hoursLeft}${t.hours}<br>${minutesLeft}${t.minutes}
        </div>
      </div>
    `;
    
    div.onclick = () => {
      if (m.marker) {
        m.marker.openPopup();
        window.map.setView(m.marker.getLatLng(), Math.max(8, window.map.getZoom()));
      }
    };
    
    cardsEl.appendChild(div);
  });
}

// ======================== FEED EM TEMPO REAL ========================
function addToRealtimeFeed(message) {
  const t = translations[STATE.lang];
  const now = Date.now();
  const messageTime = new Date(message.inserted_at).getTime();
  const secondsAgo = Math.floor((now - messageTime) / 1000);
  
  let timeText;
  if (secondsAgo < 10) {
    timeText = t.justNow;
  } else if (secondsAgo < 60) {
    timeText = `${secondsAgo} ${t.secondsAgo}`;
  } else {
    const minutesAgo = Math.floor(secondsAgo / 60);
    timeText = `${minutesAgo} ${t.minutes}`;
  }
  
  const feedItem = document.createElement("div");
  feedItem.className = "realtime-message new";
  feedItem.innerHTML = `
    <div class="realtime-time">${timeText} ‚Ä¢ üåç</div>
    <div class="realtime-text">${message.text}</div>
  `;
  
  const realtimeEl = document.getElementById("realtimeMessages");
  STATE.realtimeMessages.unshift({element: feedItem, timestamp: now});
  
  // Limitar n√∫mero de mensagens no feed
  if (STATE.realtimeMessages.length > CONFIG.MAX_REALTIME_MESSAGES) {
    const removed = STATE.realtimeMessages.pop();
    if (removed.element.parentNode === realtimeEl) {
      realtimeEl.removeChild(removed.element);
    }
  }
  
  // Adicionar ao DOM
  realtimeEl.insertBefore(feedItem, realtimeEl.firstChild);
  
  // Atualizar contador
  document.getElementById("realtimeCount").textContent = STATE.realtimeMessages.length;
  
  // Remover classe "new" ap√≥s anima√ß√£o
  setTimeout(() => {
    feedItem.classList.remove("new");
  }, 1000);
}

function updateRealtimeFeed() {
  const t = translations[STATE.lang];
  const now = Date.now();
  
  STATE.realtimeMessages.forEach(item => {
    const secondsAgo = Math.floor((now - item.timestamp) / 1000);
    let timeText;
    
    if (secondsAgo < 10) {
      timeText = t.justNow;
    } else if (secondsAgo < 60) {
      timeText = `${secondsAgo} ${t.secondsAgo}`;
    } else {
      const minutesAgo = Math.floor(secondsAgo / 60);
      timeText = `${minutesAgo} ${t.minutes}`;
    }
    
    const timeEl = item.element.querySelector('.realtime-time');
    if (timeEl) {
      timeEl.innerHTML = `${timeText} ‚Ä¢ üåç`;
    }
  });
  
  document.getElementById("realtimeCount").textContent = STATE.realtimeMessages.length;
}

// ======================== PART√çCULAS ========================
function clearParticles() {
  STATE.particleLines.forEach(line => window.map.removeLayer(line));
  STATE.particleLines = [];
}

function drawParticles() {
  clearParticles();
  
  for (let i = 0; i < STATE.markers.length; i++) {
    for (let j = i + 1; j < STATE.markers.length; j++) {
      const m1 = STATE.markers[i].getLatLng();
      const m2 = STATE.markers[j].getLatLng();
      
      if (window.map.distance(m1, m2) < CONFIG.PARTICLE_DISTANCE) {
        const color = STATE.isDarkTheme ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.2)';
        const line = L.polyline([m1, m2], {
          color: color,
          weight: 1,
          dashArray: '5, 5',
          opacity: 0.3
        }).addTo(window.map);
        STATE.particleLines.push(line);
      }
    }
  }
}

function debounceDrawParticles() {
  clearTimeout(STATE.particleTimeout);
  STATE.particleTimeout = setTimeout(drawParticles, CONFIG.DEBOUNCE_TIME);
}

// ======================== ENVIAR MENSAGEM ========================
async function sendMessage() {
  const btn = document.getElementById("registerBtn");
  const input = document.getElementById("input");
  const t = translations[STATE.lang];
  
  // Verificar geolocaliza√ß√£o
  if (!navigator.geolocation) {
    alert("GPS n√£o dispon√≠vel no seu navegador.");
    return;
  }
  
  // Verificar texto
  const text = input.value.trim();
  if (!text) {
    input.focus();
    return;
  }
  
  if (text.length > CONFIG.MAX_MESSAGE_LENGTH) {
    alert(`Mensagem muito longa (m√°x. ${CONFIG.MAX_MESSAGE_LENGTH} caracteres)`);
    return;
  }
  
  // Desabilitar bot√£o e mostrar estado de envio
  const originalText = btn.textContent;
  btn.textContent = t.sending;
  btn.disabled = true;
  
  try {
    // Obter localiza√ß√£o
    const position = await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    });
    
    // Adicionar pequena varia√ß√£o aleat√≥ria
    const lat = position.coords.latitude + (Math.random() - 0.5) * 0.02;
    const lng = position.coords.longitude + (Math.random() - 0.5) * 0.02;
    
    // Enviar para Supabase (APENAS PARA TESTES)
    const { data, error } = await supabaseClient
      .from('messages')
      .insert([{ text, latitude: lat, longitude: lng }]);
    
    if (error) throw error;
    
    // Sucesso
    btn.textContent = t.sent;
    input.value = "";
    
    // Tocar som
    document.getElementById('pingAudio').currentTime = 0;
    document.getElementById('pingAudio').play();
    
    // Atualizar atividade do usu√°rio
    const userId = Array.from(STATE.onlineUsers)[0] || 'user_' + Math.random().toString(36).substr(2, 9);
    STATE.userActivity[userId] = Date.now();
    
    // Restaurar bot√£o ap√≥s 2 segundos
    setTimeout(() => {
      btn.textContent = originalText;
      btn.disabled = false;
    }, 2000);
    
  } catch (error) {
    console.error("Erro ao enviar mensagem:", error);
    btn.textContent = t.error;
    
    // Restaurar bot√£o ap√≥s 2 segundos
    setTimeout(() => {
      btn.textContent = originalText;
      btn.disabled = false;
    }, 2000);
    
    alert("Erro ao enviar mensagem. Verifique sua conex√£o e permiss√£o de localiza√ß√£o.");
  }
}

// ======================== BUSCAR MENSAGENS ========================
async function fetchMessages() {
  try {
    const { data, error } = await supabaseClient
      .from('messages')
      .select('*')
      .order('inserted_at', { ascending: false })
      .limit(100);
    
    if (error) throw error;
    
    const now = Date.now();
    STATE.currentMessages = [];
    STATE.markers.forEach(marker => {
      if (marker.pulseInterval) clearInterval(marker.pulseInterval);
      window.map.removeLayer(marker);
    });
    STATE.markers = [];
    
    data.forEach(m => {
      if (now - new Date(m.inserted_at).getTime() <= CONFIG.EXPIRY_HOURS * 60 * 60 * 1000) {
        STATE.existingIds.add(m.id);
        const marker = createPulse(m.latitude, m.longitude, m.text, m.inserted_at);
        m.marker = marker;
        STATE.currentMessages.push(m);
        STATE.markers.push(marker);
        
        // Adicionar ao feed em tempo real (apenas mensagens recentes - √∫ltimos 5 minutos)
        if (now - new Date(m.inserted_at).getTime() <= 5 * 60 * 1000) {
          addToRealtimeFeed(m);
        }
      }
    });
    
    // Zoom para mostrar todos os marcadores
    if (STATE.isFirstLoad && STATE.markers.length > 0) {
      const group = L.featureGroup(STATE.markers);
      window.map.fitBounds(group.getBounds().pad(0.1));
      STATE.isFirstLoad = false;
    }
    
    debounceDrawParticles();
    renderCards(STATE.currentMessages);
    updateStats();
    
  } catch (error) {
    console.error("Erro ao buscar mensagens:", error);
  }
}

// ======================== ESTAT√çSTICAS ========================
function updateStats() {
  const t = translations[STATE.lang];
  const now = Date.now();
  
  // Contar pulsos ativos
  const activePulses = STATE.markers.length;
  document.getElementById('activePulses').textContent = activePulses;
  
  // Contar pulsos de hoje
  const todayPulses = STATE.currentMessages.filter(m => 
    new Date(m.inserted_at).getTime() >= STATE.todayStart
  ).length;
  document.getElementById('todayPulses').textContent = todayPulses;
  
  // Calcular pr√≥ximo vencimento
  let nextExpiry = CONFIG.EXPIRY_HOURS * 60;
  STATE.currentMessages.forEach(m => {
    const expiryTime = new Date(new Date(m.inserted_at).getTime() + (CONFIG.EXPIRY_HOURS * 60 * 60 * 1000));
    const minutesLeft = Math.floor((expiryTime - now) / (1000 * 60));
    if (minutesLeft < nextExpiry && minutesLeft > 0) {
      nextExpiry = minutesLeft;
    }
  });
  
  if (nextExpiry < 60) {
    document.getElementById('nextExpiry').textContent = `${nextExpiry}${t.minutes}`;
  } else {
    const hours = Math.floor(nextExpiry / 60);
    const minutes = nextExpiry % 60;
    document.getElementById('nextExpiry').textContent = `${hours}${t.hours} ${minutes}${t.minutes}`;
  }
  
  // Atualizar feed em tempo real
  updateRealtimeFeed();
}

// ======================== USU√ÅRIOS ONLINE ========================
function updateOnlineUsers() {
  const now = Date.now();
  
  // Remover usu√°rios inativos
  Object.keys(STATE.userActivity).forEach(userId => {
    if (now - STATE.userActivity[userId] > CONFIG.ONLINE_TIMEOUT) {
      STATE.onlineUsers.delete(userId);
      delete STATE.userActivity[userId];
    }
  });
  
  // Gerar n√∫mero aleat√≥rio de usu√°rios online (para simula√ß√£o)
  // Em produ√ß√£o, isso viria do backend
  const baseCount = Math.max(STATE.onlineUsers.size, 1);
  const randomFactor = Math.floor(Math.random() * 10) - 3;
  const onlineCount = Math.max(1, baseCount + randomFactor);
  
  document.getElementById('onlineCount').textContent = onlineCount;
}

// ======================== LIMPEZA ========================
function cleanupOldMarkers() {
  const now = Date.now();
  const markersToRemove = [];
  const expiryTime = CONFIG.EXPIRY_HOURS * 60 * 60 * 1000;
  
  STATE.markers = STATE.markers.filter(marker => {
    const popupText = marker.getPopup()?.getContent();
    if (!popupText) return true;
    
    // Extrair data da mensagem
    const dateMatch = popupText.match(/(\d{1,2}):(\d{2}) (AM|PM)/);
    if (!dateMatch) return true;
    
    // Verificar tempo de vida
    const inserted = marker.options.inserted_at ? new Date(marker.options.inserted_at).getTime() : 0;
    if (now - inserted > expiryTime) {
      markersToRemove.push(marker);
      return false;
    }
    return true;
  });
  
  // Remover marcadores antigos
  markersToRemove.forEach(marker => {
    if (marker.pulseInterval) clearInterval(marker.pulseInterval);
    window.map.removeLayer(marker);
  });
  
  // Atualizar lista de mensagens
  STATE.currentMessages = STATE.currentMessages.filter(m => {
    return markersToRemove.indexOf(m.marker) === -1;
  });
  
  renderCards(STATE.currentMessages);
  debounceDrawParticles();
  updateStats();
}

// ======================== EVENT LISTENERS ========================
function setupEventListeners() {
  // Bot√£o de registro
  document.getElementById("registerBtn").addEventListener("click", sendMessage);
  
  // Enviar com Enter (Shift+Enter para nova linha)
  document.getElementById("input").addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  
  // Bot√£o de som
  document.getElementById("soundToggle").addEventListener("click", () => {
    const audio = document.getElementById("ambientAudio");
    const pingAudio = document.getElementById("pingAudio");
    STATE.isSoundOn = !STATE.isSoundOn;
    
    document.getElementById("soundToggle").textContent = 
      translations[STATE.lang][STATE.isSoundOn ? "soundOn" : "soundOff"];
    
    if (STATE.isSoundOn) {
      audio.volume = 0.1;
      audio.play().catch(e => console.log("Autoplay bloqueado:", e));
      pingAudio.volume = 0.3;
    } else {
      audio.pause();
    }
  });
  
  // Bot√£o de idioma
  document.getElementById("languageToggle").addEventListener("click", toggleLanguage);
  
  // Bot√£o de tema
  document.getElementById("themeToggle").addEventListener("click", () => {
    STATE.isDarkTheme = !STATE.isDarkTheme;
    document.body.classList.toggle('light-theme', !STATE.isDarkTheme);
    document.getElementById("themeToggle").textContent = 
      translations[STATE.lang][STATE.isDarkTheme ? "themeLight" : "themeDark"];
    debounceDrawParticles();
  });
  
  // Atualizar atividade do usu√°rio em intera√ß√µes
  document.addEventListener('click', () => {
    if (STATE.onlineUsers.size > 0) {
      const userId = Array.from(STATE.onlineUsers)[0];
      STATE.userActivity[userId] = Date.now();
    }
  });
  
  // Permitir arrastar cards no mobile
  let startY;
  const cardsEl = document.getElementById("cards");
  const realtimeEl = document.getElementById("realtimeMessages");
  
  [cardsEl, realtimeEl].forEach(el => {
    el.addEventListener('touchstart', (e) => {
      startY = e.touches[0].clientY;
    }, { passive: true });
    
    el.addEventListener('touchmove', (e) => {
      if (!startY) return;
      const y = e.touches[0].clientY;
      const diff = startY - y;
      
      if (Math.abs(diff) > 10) {
        el.scrollTop += diff;
        startY = y;
      }
    }, { passive: true });
  });
}

// ======================== EXPORTAR FUN√á√ïES PARA DEBUG ========================
// (Opcional - para console do navegador)
window.debug = {
  getState: () => STATE,
  getMarkers: () => STATE.markers,
  getMessages: () => STATE.currentMessages,
  getOnlineUsers: () => STATE.onlineUsers.size,
  clearParticles,
  drawParticles,
  fetchMessages,
  forceCleanup: cleanupOldMarkers
};
</script>
</body>
</html>