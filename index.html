<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1440 Sensorial Global</title>
<meta name="description" content="Envie pulsos anônimos pelo mundo e veja mensagens em tempo real em um mapa interativo.">
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
html, body { height:100%; margin:0; padding:0; font-family:Georgia, serif; background:#0f1115; color:#fff; }
#map { width:100%; height:70vh; min-height:300px; }
.panel { width:100%; height:30vh; min-height:120px; padding:10px; background:rgba(15,17,21,0.85); display:flex; flex-direction:column; }
.time { text-align:center; font-size:2rem; margin-bottom:5px; }
textarea { width:100%; background:transparent; border:1px solid #555; color:#eaeaea; padding:8px; resize:none; font-family:Georgia, serif; }
button { margin-top:5px; padding:6px 12px; background:none; border:1px solid #777; color:#eaeaea; cursor:pointer; font-family:Georgia, serif; }
.cards { margin-top:5px; display:flex; flex-direction:column; gap:3px; max-height:100%; overflow-y:auto; }
.card { background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); padding:5px; font-size:0.85rem; cursor:pointer; transition:0.2s; }
.card:hover { background:rgba(255,255,255,0.15); }
.leaflet-popup-content { color:#000; font-size:0.9rem; font-family:Georgia, serif; }
@media(max-width:600px){
  .time { font-size:1.5rem; }
  button { font-size:0.9rem; }
}
</style>
</head>
<body>

<div id="map"></div>

<div class="panel">
  <div class="time" id="time">--:--</div>
  <textarea id="input"></textarea>
  <button id="registerBtn"></button>
  <div class="cards" id="cards"></div>
</div>

<audio id="pingAudio" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>

<!-- LEAFLET -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js" id="supabase-script"></script>

<script>
document.getElementById("supabase-script").onload = () => {

  // ======================== SUPABASE ========================
  const SUPABASE_URL = 'https://eheyuoeagrfvqxgpmaex.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_1qg0L7fR4drbzru3sQmqtQ_eCTCZECn';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const pingAudio = document.getElementById("pingAudio");

  // ======================== TRADUÇÃO AUTOMÁTICA ========================
  const translations = {
    pt: { placeholder:"Deixe um pulso no mundo...", register:"Registrar", expires:"Expira em 24h" },
    en: { placeholder:"Leave a pulse in the world...", register:"Register", expires:"Expires in 24h" },
    es: { placeholder:"Deja un pulso en el mundo...", register:"Registrar", expires:"Expira en 24h" }
  };
  let lang = navigator.language.startsWith("en") ? "en" :
             navigator.language.startsWith("es") ? "es" : "pt";
  document.getElementById("input").placeholder = translations[lang].placeholder;
  document.getElementById("registerBtn").textContent = translations[lang].register;

  // ======================== MAPA ========================
  const map = L.map('map').setView([20,0],2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap contributors',
    maxZoom:19
  }).addTo(map);

  // ======= RELÓGIO =======
  const timeEl = document.getElementById("time");
  function updateTime(){ 
    const d=new Date(); 
    timeEl.textContent = String(d.getHours()).padStart(2,'0')+":"+String(d.getMinutes()).padStart(2,'0'); 
  }
  updateTime(); setInterval(updateTime,1000);

  // ======= VARIÁVEIS =======
  const cardsEl = document.getElementById("cards");
  const maxCards = 7;
  let markers = [];
  let particleLines = [];
  let currentMessages = [];

  // ======= FUNÇÃO DE COR DO PULSO =======
  function getPulseColor(){
    const h = new Date().getHours();
    if(h<5) return "#4d79ff";
    if(h<12) return "#ffd966";
    if(h<18) return "#ff9900";
    return "#9933ff";
  }

  // ======= CRIAR PULSO =======
  function createPulse(lat,lng,text,date){
    const color = getPulseColor();
    const marker = L.circleMarker([lat,lng],{
      radius:10, fillColor:color, fillOpacity:0.8, stroke:true, color:"#fff", weight:1
    }).addTo(map);
    marker.bindPopup(`<strong>${text}</strong><br>${new Date(date).toLocaleString()}<br>${translations[lang].expires}`);

    let r=10;
    const pulse = setInterval(()=>{
      r+=0.5;
      marker.setRadius(r);
      marker.setStyle({fillOpacity:Math.max(0,0.8-(r-10)/20)});
      if(r>=30) r=10;
    },50);

    return marker;
  }

  // ======= CARDS =======
  function renderCards(messages){
    cardsEl.innerHTML="";
    messages.slice(0,maxCards).forEach(m=>{
      const div = document.createElement("div");
      div.className="card";
      const date = new Date(m.inserted_at);
      div.innerHTML=`<strong>${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}</strong> - "${m.text}"`;
      div.onclick = ()=>{ if(m.marker) m.marker.openPopup(); }
      cardsEl.appendChild(div);
    });
  }

  // ======= ENVIAR MENSAGEM =======
  async function sendMessage(){
    if(!navigator.geolocation) return alert("GPS não disponível");
    const text = document.getElementById("input").value.trim();
    if(!text) return;
    document.getElementById("input").value="";
    pingAudio.currentTime=0; pingAudio.play();

    navigator.geolocation.getCurrentPosition(async pos=>{
      const lat = pos.coords.latitude + (Math.random()-0.5)*0.02;
      const lng = pos.coords.longitude + (Math.random()-0.5)*0.02;
      const {data,error} = await supabaseClient.from('messages').insert([{text,latitude:lat,longitude:lng}]);
      if(error) console.error(error);
    });
  }
  document.getElementById("registerBtn").addEventListener("click", sendMessage);

  // ======= BUSCAR MENSAGENS EXISTENTES =======
  async function fetchMessages(){
    const {data,error} = await supabaseClient.from('messages').select('*').order('inserted_at',{ascending:false}).limit(100);
    if(error) return console.error(error);
    const now = Date.now();
    currentMessages=[];
    data.forEach(m=>{
      if(now - new Date(m.inserted_at).getTime() <= 24*60*60*1000){
        const marker = createPulse(m.latitude,m.longitude,m.text,m.inserted_at);
        m.marker = marker;
        currentMessages.push(m);
        markers.push(marker);
      }
    });
    renderCards(currentMessages);
  }
  fetchMessages();

  // ======= REALTIME SUPABASE =======
  supabaseClient.channel('public:messages')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'}, payload=>{
      const m = payload.new;
      const marker = createPulse(m.latitude,m.longitude,m.text,m.inserted_at);
      m.marker = marker;
      markers.push(marker);
      currentMessages.unshift(m);
      renderCards(currentMessages);
    }).subscribe();

  // ======= PONTO INICIAL PARA MUNDO SILENCIOSO =======
  const silentMarker = L.circleMarker([0,0],{
    radius:8, fillColor:'#555', fillOpacity:0.2, stroke:false
  }).addTo(map);

};
</script>
</body>
</html>